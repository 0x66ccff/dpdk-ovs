Intel® DPDK vSwitch provides two main testing utilities: ovs-testsuite and OFTest. Both are described in detail below.

______

## ovs-testsuite

The Open vSwitch testsuite (`ovs-testsuite`) is a set of unit tests that form the larger part of OVS' test framework. ovs-testsuite is an OVS-specific collection of unit tests that are designed to test atomic pieces of the code (as with all unit tests). This framework is written in GNU Autotest, with supporting Python scripts and C unit test files.

This section contains instructions on how to configure and test Intel® DPDK vSwitch using ovs-testsuite.

### Setup

The testsuite requires a minor amount of setup, due to the current design of Intel® DPDK vSwitch. Many of the tests will not run "out of the box", as calls to utilities used by the tests, such as `ovs-ofctl`, assume that said utilities are in the `PATH`. This assumption is not the case, as Intel® DPDK vSwitch does not "install" and place binaries in the `/bin` folder. As a result, the path must be modified, similar to the following:

```bash
export PATH=$PATH:$(OVS_DIR)/utilities:$(OVS_DIR)/ovsdb:$(OVS_DIR)/vswitchd
```

Additionally, Hugepages must be mounted before running ovs-testsuite. Please see the [Installation guide][doc-installation] for more information on how to do this.

### Run Tests

Tests may be run using the Open vSwitch Makefile, or via the testsuite script generated by `autoconf`. Details of both methods follow.

#### Run Tests via Make

To run all the Open vSwitch unit tests in Intel® DPDK vSwitch, one at a time:

```bash
cd openvswitch
make check
```

Tests do not have interdependencies, so any subset may be run independently. For example, to run only a subset of tests, test 111 and tests 222 through 333:

```bash
make check TESTSUITEFLAGS='111 222-333'
```

Alternatively, to run tests matching a given keyword:

```bash
make check TESTSUITEFLAGS='-k ovsdb'
```

To list all available tests:

```bash
make check TESTSUITEFLAGS=--list
```

For all other options, execute `--help`:

```bash
make check TESTSUITEFLAGS=--help
```

#### Run Tests via `testsuite` Script

It is also possible to run the tests via the testsuite script generated by autoconf. This method is useful to run tests without rebuilding them (They are built automatically when Intel® DPDK vSwitch is built).

To run all the Open vSwitch unit tests in Intel® DPDK vSwitch, one at a time:

```bash
cd openvswitch/tests
./testsuite
```

To clean logs and results of previous tests:

```bash
./testsuite -c [tests]
```

For all other options, execute `--help`:

```bash
./testsuite --help
```

______

## OFTest

OFTest is a test framework meant to exercise a candidate OpenFlow switch — in this case, Intel® DPDK vSwitch. It is especially useful when adding additional functionality to the switch or when modifying existing functionality. General information on the framework, along with the framework itself can be found here:

http://www.projectfloodlight.org/oftest/

This section contains instructions on how to configure and test Intel® DPDK vSwitch using OFTest.

### Get OFtest

Clone the OFTest repo from GitHub:

```bash
git clone git://github.com/floodlight/oftest
```

Checkout the version of OFTest that Intel® DPDK vSwitch has been validated against:

```bash
git checkout 624f55a79f774efdae0864715f0ca55ea6335aa6
```

OFTest requires a number of additional utilities to be installed prior to use, including, but not limited to:
* Python 2.5, or 2.6
* scapy
* tcpdump
* `root` privileges on the host

Refer to the “Pre-requisites” section of the Project Floodlight Getting Started Guide [here][oft-gsg-long] for a full list of prerequisites.

**Note:** If Python has not been compiled with IPv6 support, Scapy will issue an error. To avoid this error, either:

* Recompile Python, adding support for IPv6 by passing `--enable_ipv6` to the
configure step
* Remove the following lines from `oftest/src/python/oftest/packet.py`:

```bash
import scapy.route6
import scapy.layers.inet6
IPv6 = scapy.layers.inet6.IPv6
ICMPv6Unknown = scapy.layers.inet6.ICMPv6Unknown
ICMPv6EchoRequest = scapy.layers.inet6.ICMPv6EchoRequest
```

### Initial Setup

Compile DPDK, and insert the KNI kernel module:

```bash
cd DPDK
make install T=x86_64-ivshmem-linuxapp-gcc
insmod x86_64-ivshmem-linuxapp-gcc/kmod/rte_kni.ko
```

On the host, remove any configuration associated with a previous run of the switch:

```bash
pkill -9 ovs
rm -rf /usr/local/var/run/openvswitch/
rm -rf /usr/local/etc/openvswitch/
mkdir -p /usr/local/var/run/openvswitch/
mkdir -p /usr/local/etc/openvswitch/
rm -f /tmp/conf.db
```

Initialise the Open vSwitch database server:

```bash
./ovsdb-tool create /usr/local/etc/openvswitch/conf.db $OPENVSWITCH_DIR/vswitchd/vswitch.ovsschema
./ovsdb-server --remote=punix:/usr/local/var/run/openvswitch/db.sock --remote=db:Open_vSwitch,manager_options &
```

### Configure `ovs_dpdk`

Add a bridge to the switch:

```bash
./ovs-vsctl --no-wait add-br br0 -- set Bridge br0 datapath_type=dpdk
```

Configure the switch to use an OpenFlow controller and disable in-band management:

```bash
./ovs-vsctl set-controller br0 tcp:127.0.0.1:6653
./ovs-vsctl set Bridge br0 other_config:disable-in-band=true
```

Add four vEth ports to the bridge:

```bash
./ovs-vsctl add-br br0 -- set Bridge br0 datapath_type=dpdk
./ovs-vsctl add-port br0 ovs_dpdk_64 --set Interface ovs_dpdk_64 type=dpdk
  ofport_request=64
./ovs-vsctl add-port br0 ovs_dpdk_65 --set Interface ovs_dpdk_65 type=dpdk
  ofport_request=65
./ovs-vsctl add-port br0 ovs_dpdk_66 --set Interface ovs_dpdk_66 type=dpdk
  ofport_request=66
./ovs-vsctl add-port br0 ovs_dpdk_67 --set Interface ovs_dpdk_67 type=dpdk
  ofport_request=67
```

**Note:** valid vEth port values range from `64`-`71`

Confirm the ports have been successfully added:

```bash
sudo ./openvswitch/utilities/ovs-vsctl show
```

Start `ovs_dpdk`:

```bash
./ovs_dpdk -c 0x0f -n 4 --proc-type primary --socket-mem 2048,2048-- -p 0x03
-n 2 -v 4 --vswitchd=0 --client_switching_core=1 --config="(0,0,2),(1,0,3)"
```

Finally, start `ovs-vswitchd`:

```bash
./ovs-vswitchd -c 0x10 --proc-type=secondary
```

Delete the default flows present from the bridge:

```bash
./ovs-ofctl del-flows br0
```

The vport devices — which, by default, have names corresponding to vEthX —
should be brought up. For example:

```bash
ifconfig vEth0 up
ifconfig vEth1 up
ifconfig vEth2 up
ifconfig vEth3 up
```

### Run Tests

A full guide on how to execute OFTest can be found at the [OFTest site][oft-gsg]. In this case, OFTest should be configured to use the vEth devices created by `ovs_dpdk`. For example:

```bash
./oft -i 64@vEth0 -i 65@vEth1 -i 66@vEth2 -i 67@vEth3
```

Intel® DPDK vSwitch complies with a subset of OpenFlow specification v1.0; by default, OFTest tests switch compatibility against v1.0 of the OpenFlow specification, but this can be specified explicitly using one of the command line options:

```bash
./oft --of-version 1.0 [-i interfaces...] [--port=6653]
```

**Note:** Port 6653 is the default value for the controller port. Older versions of OFTest use port 6633 - if you encounter difficulty running OFTest, consider using the `--port` switch.

A current list of the expected results for OFTest can be found in the source package.

______

[oft-gsg]: http://docs.projectfloodlight.org/display/OFTest/Getting+Started
[oft-gsg-long]: http://docs.projectfloodlight.org/display/OFTest/Longer+Start
[doc-installation]: 01_Installation.md
